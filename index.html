<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Availability - çœŸå¯¦é€£ç·šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    </style>
</head>
<body class="bg-stone-50 text-slate-800 font-sans">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative flex flex-col">
        <!-- Loading State -->
        <div id="loading-overlay" class="absolute inset-0 bg-white z-50 flex items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>

        <!-- Content Area -->
        <div id="main-content" class="flex-1 flex flex-col hidden">
            <!-- Dynamic Content Injected Here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- 1. Firebase è¨­å®šå€åŸŸ (è«‹ä¿®æ”¹é€™è£¡) ---
        // æ‚¨çš„ç¶²é å¡ä½æ˜¯å› ç‚ºç¼ºå°‘é€™çµ„è¨­å®šã€‚è«‹å» Firebase Console ç”³è«‹ä¸¦è²¼ä¸Šã€‚
        const firebaseConfig = {
            apiKey: "?",
            authDomain: "?.firebaseapp.com",
            projectId: "??",
            storageBucket: "?.firebasestorage.app",
            messagingSenderId: "?",
            appId: "?"
            measurementId: "?"
        };
        
        // å˜—è©¦è®€å–ç’°å¢ƒè®Šæ•¸ (Gemini Canvas ç’°å¢ƒ)ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ä¸Šæ–¹çš„è¨­å®š
        const finalConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-event-app';

        let app, auth, db, currentUser;

        // æª¢æŸ¥è¨­å®šæ˜¯å¦æœ‰æ•ˆ
        function isConfigured() {
            return finalConfig && finalConfig.apiKey !== "?";
        }

        // --- 2. App State & Logic ---
        const state = {
            view: 'landing', // landing, create, join, calendar, result, admin
            eventId: null,
            eventData: null,
            userName: '',
            userColor: '',
            selectedDates: new Set(),
            viewDate: new Date(),
            unsubscribe: null // Firestore listener
        };

        const COLORS = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e'];

        // Helper: Date formatting
        const formatDateKey = (date) => date.toISOString().split('T')[0];

        // --- 3. Core Functions ---

        async function initApp() {
            if (!isConfigured()) {
                renderSetupGuide();
                hideLoading();
                return;
            }

            try {
                app = initializeApp(finalConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        // Check URL params for eventId
                        const urlParams = new URLSearchParams(window.location.search);
                        const eventIdParam = urlParams.get('id');

                        if (eventIdParam) {
                            state.eventId = eventIdParam;
                            loadEvent(eventIdParam);
                        } else {
                            renderLanding();
                            hideLoading();
                        }
                    }
                });
            } catch (error) {
                console.error("Auth/Init failed:", error);
                // alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console");
                document.getElementById('main-content').innerHTML = `<div class="p-8 text-center text-red-500">
                    <h2 class="font-bold text-xl mb-2">é€£ç·šéŒ¯èª¤</h2>
                    <p class="text-sm">è«‹æª¢æŸ¥ Firebase è¨­å®šæ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ˜¯å¦å·²åœ¨ Firebase Console é–‹å•Ÿ Firestore è³‡æ–™åº«æ¬Šé™ã€‚</p>
                    <pre class="bg-gray-100 p-2 mt-4 text-xs text-left overflow-auto">${error.message}</pre>
                </div>`;
                hideLoading();
            }
        }

        // Action: Create Event
        window.createEvent = async () => {
            const nameInput = document.getElementById('create-name');
            const name = nameInput.value.trim();
            if (!name) return alert('è«‹è¼¸å…¥æ´»å‹•åç¨±');

            showLoading();
            
            try {
                // Generate a random ID manually to ensure clean URLs
                const newEventId = Math.random().toString(36).substring(2, 8) + Date.now().toString(36).substring(4, 8);
                // Use the correct path structure required by the system prompt
                // Collection: artifacts/{appId}/public/data/events
                // Doc: {newEventId}
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'events', newEventId);

                const today = new Date();
                const endDate = new Date();
                endDate.setDate(today.getDate() + 60);

                const newEvent = {
                    id: newEventId,
                    name: name,
                    organizerId: currentUser.uid,
                    createdAt: new Date().toISOString(),
                    startDate: formatDateKey(today),
                    endDate: formatDateKey(endDate),
                    participants: [] // Stores {name, color, uid, selectedDates}
                };

                await setDoc(docRef, newEvent);
                
                // Redirect logic (Update URL without reload)
                const newUrl = `${window.location.pathname}?id=${newEventId}`;
                window.history.pushState({path: newUrl}, '', newUrl);
                
                state.eventId = newEventId;
                state.eventData = newEvent;
                
                // Determine next step: Auto-join as organizer?
                // For simplicity, let's go to Share screen directly
                renderShare();
            } catch (e) {
                console.error(e);
                alert('å»ºç«‹å¤±æ•—: ' + e.message);
            } finally {
                hideLoading();
            }
        };

        // Action: Load Event (Real-time listener)
        function loadEvent(eventId) {
            showLoading();
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'events', eventId);

            state.unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.eventData = docSnap.data();
                    checkUserStatus();
                } else {
                    renderNotFound();
                }
                hideLoading();
            }, (error) => {
                console.error("Listen failed:", error);
                renderNotFound();
                hideLoading();
            });
        }

        function checkUserStatus() {
            // Check localStorage for saved name for this event to auto-login
            const savedName = localStorage.getItem(`event_${state.eventId}_name`);
            const existingParticipant = state.eventData.participants.find(p => p.name === savedName || p.uid === currentUser.uid);

            if (state.view === 'share' || state.view === 'admin') return; // Stay on these views if active

            if (existingParticipant) {
                state.userName = existingParticipant.name;
                state.userColor = existingParticipant.color;
                state.selectedDates = new Set(existingParticipant.selectedDates);
                
                // If coming from link first time but user exists, go to result
                if (state.view === 'landing' || state.view === 'join') {
                    renderResult();
                } else {
                    // Refresh current view (in case data updated)
                    if (state.view === 'calendar') renderCalendar();
                    if (state.view === 'result') renderResult();
                }
            } else {
                renderJoin();
            }
        }

        // Action: Join/Login
        window.joinEvent = () => {
            const input = document.getElementById('join-name');
            const name = input.value.trim();
            if (!name) return alert('è«‹è¼¸å…¥æ‚¨çš„åç¨±');

            // Check if name already taken by someone else (not me)
            const existing = state.eventData.participants.find(p => p.name === name);
            if (existing && existing.uid !== currentUser.uid) {
                if(!confirm(`åç¨± "${name}" å·²å­˜åœ¨ã€‚é€™æ˜¯æ‚¨ä¹‹å‰çš„ç´€éŒ„å—ï¼Ÿ\né»æ“Šã€Œç¢ºå®šã€å°‡è¼‰å…¥ä¸¦å…è¨±ä¿®æ”¹ã€‚\né»æ“Šã€Œå–æ¶ˆã€è«‹æ›´æ›åç¨±ã€‚`)) {
                    return;
                }
                state.userColor = existing.color;
                state.selectedDates = new Set(existing.selectedDates);
            } else {
                // New user
                const nextColorIndex = state.eventData.participants.length % COLORS.length;
                state.userColor = COLORS[nextColorIndex];
                state.selectedDates = new Set();
            }

            state.userName = name;
            localStorage.setItem(`event_${state.eventId}_name`, name);
            renderCalendar();
        };

        // Action: Toggle Date
        window.toggleDate = (dateStr) => {
            if (state.selectedDates.has(dateStr)) {
                state.selectedDates.delete(dateStr);
            } else {
                state.selectedDates.add(dateStr);
            }
            renderCalendar(); // Re-render to show selection
        };

        // Action: Submit Votes
        window.submitVotes = async () => {
            showLoading();
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'events', state.eventId);
                
                // Create clean participant object
                const participantData = {
                    name: state.userName,
                    color: state.userColor,
                    uid: currentUser.uid,
                    selectedDates: Array.from(state.selectedDates)
                };

                const otherParticipants = state.eventData.participants.filter(p => p.name !== state.userName);
                const updatedParticipants = [...otherParticipants, participantData];

                await updateDoc(docRef, {
                    participants: updatedParticipants
                });

                renderResult();
            } catch (e) {
                console.error(e);
                alert('æäº¤å¤±æ•—: ' + e.message);
            } finally {
                hideLoading();
            }
        };

        // Action: Delete Participant (Admin)
        window.deleteParticipant = async (targetName) => {
            if (!confirm(`ç¢ºå®šè¦ç§»é™¤ ${targetName} å—ï¼Ÿ`)) return;
            
            showLoading();
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'events', state.eventId);
                const updatedParticipants = state.eventData.participants.filter(p => p.name !== targetName);
                
                await updateDoc(docRef, {
                    participants: updatedParticipants
                });
            } catch (e) {
                alert('ç§»é™¤å¤±æ•—');
            } finally {
                hideLoading();
            }
        };

        // UI: Navigation
        window.goToAdmin = () => renderAdmin();
        window.goToResult = () => renderResult();
        window.copyLink = () => {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => alert('é€£çµå·²è¤‡è£½ï¼'));
        };
        window.changeMonth = (offset) => {
            state.viewDate.setMonth(state.viewDate.getMonth() + offset);
            if(state.view === 'calendar') renderCalendar();
            if(state.view === 'result') renderResult();
        }

        // --- 4. Render Functions ---

        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); }

        function renderSetupGuide() {
            document.getElementById('main-content').innerHTML = `
                <div class="flex-1 p-8 space-y-6 overflow-y-auto">
                    <h1 class="text-2xl font-bold text-slate-800">æœ€å¾Œä¸€æ­¥ï¼šè¨­å®šè³‡æ–™åº«</h1>
                    <div class="bg-amber-50 border-l-4 border-amber-400 p-4">
                        <p class="text-sm text-amber-700">æ‚¨éœ€è¦å°‡æ­¤ç¨‹å¼ç¢¼é€£çµåˆ°æ‚¨çš„ Google Firebase æ‰èƒ½å„²å­˜è³‡æ–™ã€‚</p>
                    </div>
                    
                    <ol class="list-decimal pl-5 space-y-4 text-sm text-slate-600">
                        <li>å‰å¾€ <a href="https://console.firebase.google.com/" target="_blank" class="text-indigo-600 underline font-bold">Firebase Console</a> ä¸¦ç™»å…¥ Google å¸³è™Ÿã€‚</li>
                        <li>é»æ“Š <strong>ã€Œå»ºç«‹å°ˆæ¡ˆã€</strong> (Create a project)ã€‚</li>
                        <li>å°ˆæ¡ˆå»ºç«‹å¾Œï¼Œåœ¨é¦–é é»æ“Š <strong>ã€ŒWebã€</strong> åœ–ç¤º (é¡ä¼¼ </> çš„ç¬¦è™Ÿ) ä¾†æ–°å¢æ‡‰ç”¨ç¨‹å¼ã€‚</li>
                        <li>è¨»å†Šå®Œç•¢å¾Œï¼Œæ‚¨æœƒçœ‹åˆ°ä¸€æ®µ <code>const firebaseConfig = { ... };</code> çš„ç¨‹å¼ç¢¼ã€‚</li>
                        <li><strong>è«‹ç”¨æ–‡å­—ç·¨è¼¯å™¨ (å¦‚è¨˜äº‹æœ¬) æ‰“é–‹é€™å€‹ .html æª”æ¡ˆ</strong>ï¼Œæ‰¾åˆ°ç¬¬ 35 è¡Œå·¦å³çš„ <code>YOUR_API_KEY</code> å€åŸŸã€‚</li>
                        <li>å°‡æ‚¨çš„è¨­å®šå€¼è²¼ä¸Šè¦†è“‹ã€‚</li>
                    </ol>

                    <div class="bg-slate-800 text-slate-200 p-4 rounded-lg text-xs font-mono overflow-x-auto">
                        // ç¯„ä¾‹ï¼šå°‡æ‚¨çš„æª”æ¡ˆä¿®æ”¹æˆé€™æ¨£<br>
                        const firebaseConfig = {<br>
                        &nbsp;&nbsp;apiKey: "AIzaSyD...",<br>
                        &nbsp;&nbsp;authDomain: "project.firebaseapp.com",<br>
                        &nbsp;&nbsp;projectId: "project-id",<br>
                        &nbsp;&nbsp;...<br>
                        };
                    </div>

                    <p class="text-xs text-slate-500 mt-4">è¨­å®šå®Œæˆä¸¦å„²å­˜æª”æ¡ˆå¾Œï¼Œé‡æ–°æ•´ç†æ­¤ç¶²é å³å¯é–‹å§‹ä½¿ç”¨ï¼</p>
                </div>
            `;
        }

        function renderLanding() {
            state.view = 'landing';
            const html = `
                <div class="flex-1 flex flex-col items-center justify-center p-8 space-y-8 bg-gradient-to-br from-indigo-50 to-white">
                    <div class="w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-4xl font-bold shadow-xl shadow-indigo-200">Ev</div>
                    <div class="text-center space-y-2">
                        <h1 class="text-3xl font-extrabold text-slate-900">èšæœƒç¥å™¨</h1>
                        <p class="text-slate-500">æœ€ç°¡å–®çš„å–¬æ™‚é–“å·¥å…·ã€‚<br>ç™¼èµ·æ´»å‹•ã€åˆ†äº«é€£çµã€å³æ™‚æŠ•ç¥¨ã€‚</p>
                    </div>
                    <div class="w-full space-y-4">
                        <input type="text" id="create-name" placeholder="è¼¸å…¥æ´»å‹•åç¨± (ä¾‹å¦‚: é€±äº”æ™šé¤)" class="w-full p-4 text-center border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none text-lg transition-colors">
                        <button onclick="createEvent()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all transform active:scale-95 text-lg">
                            å»ºç«‹æ–°æ´»å‹•
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function renderJoin() {
            state.view = 'join';
            const html = `
                <div class="bg-indigo-600 p-8 pt-12 pb-10 text-white">
                    <h1 class="text-3xl font-bold mb-2">${state.eventData.name}</h1>
                    <p class="opacity-90">é‚€è«‹ä½ å¡«å¯«å¯å‡ºå¸­çš„æ™‚é–“</p>
                </div>
                <div class="flex-1 -mt-6 bg-white rounded-t-3xl shadow-inner p-8 flex flex-col">
                    <div class="space-y-6 mt-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">ä½ çš„æš±ç¨±</label>
                            <input type="text" id="join-name" placeholder="è¼¸å…¥åç¨±" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none text-lg">
                        </div>
                        <button onclick="joinEvent()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all text-lg mt-4">
                            é–‹å§‹é¸æ“‡æ™‚é–“
                        </button>
                    </div>
                    <div class="mt-auto pt-8 text-center">
                        <p class="text-xs text-slate-400">ç›®å‰å·²æœ‰ ${state.eventData.participants.length} äººåƒèˆ‡</p>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function renderShare() {
            state.view = 'share';
            const html = `
                <div class="flex-1 flex flex-col items-center justify-center p-8 bg-slate-50 space-y-8">
                    <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-4xl shadow-sm">âœ“</div>
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-slate-900">æ´»å‹•å·²å»ºç«‹ï¼</h2>
                        <p class="text-slate-500 mt-2">åˆ†äº«ä¸‹æ–¹é€£çµçµ¦æœ‹å‹</p>
                    </div>
                    
                    <div class="w-full bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between cursor-pointer hover:border-indigo-300 transition" onclick="copyLink()">
                        <div class="truncate text-slate-600 text-sm font-mono mr-4 flex-1">${window.location.href}</div>
                        <span class="text-indigo-600 font-bold text-sm whitespace-nowrap">è¤‡è£½</span>
                    </div>

                    <button onclick="checkUserStatus()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition">
                        é€²å…¥æ´»å‹•çœ‹æ¿
                    </button>
                    
                    ${state.eventData.organizerId === currentUser.uid ? 
                        `<button onclick="goToAdmin()" class="text-slate-400 text-sm hover:text-slate-600 underline">ç®¡ç†å¾Œå°</button>` : ''}
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function renderCalendar() {
            state.view = 'calendar';
            const year = state.viewDate.getFullYear();
            const month = state.viewDate.getMonth();
            const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const today = new Date();
            today.setHours(0,0,0,0);
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 60);
            maxDate.setHours(0,0,0,0);

            let daysHTML = '';
            for(let i=0; i<firstDay; i++) daysHTML += `<div></div>`;
            
            for(let i=1; i<=daysInMonth; i++) {
                const date = new Date(year, month, i);
                const dateStr = formatDateKey(date);
                const isDisabled = date < today || date > maxDate;
                const isSelected = state.selectedDates.has(dateStr);
                
                let className = `aspect-square rounded-lg flex items-center justify-center text-sm font-bold relative transition-all select-none `;
                let onClick = '';

                if (isDisabled) {
                    className += `bg-slate-50 text-slate-300 cursor-not-allowed`;
                } else if (isSelected) {
                    className += `bg-indigo-600 text-white shadow-md cursor-pointer transform scale-105`;
                    onClick = `onclick="toggleDate('${dateStr}')"`;
                } else {
                    className += `bg-white text-slate-700 border border-slate-100 hover:border-indigo-200 cursor-pointer`;
                    onClick = `onclick="toggleDate('${dateStr}')"`;
                }

                daysHTML += `<div class="${className}" ${onClick}>
                    ${i}
                    ${isSelected ? '<div class="absolute bottom-1 right-1 text-[8px]">âœ“</div>' : ''}
                </div>`;
            }

            const html = `
                <div class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-10 border-b border-slate-100">
                    <h2 class="font-bold text-slate-800 text-lg">${year}å¹´ ${monthNames[month]}</h2>
                    <div class="space-x-1">
                        <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600">â†</button>
                        <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600">â†’</button>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 flex-1 overflow-y-auto">
                    <div class="calendar-grid mb-2 text-center text-xs text-slate-400 font-bold">
                        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                    </div>
                    <div class="calendar-grid">
                        ${daysHTML}
                    </div>
                </div>
                <div class="p-4 bg-white border-t border-slate-100 shadow-lg z-20">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${state.userColor}"></span>
                            <span class="text-xs text-slate-600 font-medium">${state.userName}</span>
                        </div>
                        <span class="text-xs text-slate-500">å·²é¸ ${state.selectedDates.size} å¤©</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="goToResult()" class="flex-1 bg-white border border-slate-300 text-slate-600 font-bold py-3 px-4 rounded-xl">å–æ¶ˆ</button>
                        <button onclick="submitVotes()" class="flex-[2] bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md">æäº¤é¸æ“‡</button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function renderResult() {
            state.view = 'result';
            const year = state.viewDate.getFullYear();
            const month = state.viewDate.getMonth();
            const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const today = new Date();
            today.setHours(0,0,0,0);
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 60);
            maxDate.setHours(0,0,0,0);

            // Calculate Best Day
            const dateCounts = {};
            state.eventData.participants.forEach(p => {
                p.selectedDates.forEach(d => {
                    dateCounts[d] = (dateCounts[d] || 0) + 1;
                });
            });
            const maxCount = Math.max(...Object.values(dateCounts), 0);

            let daysHTML = '';
            for(let i=0; i<firstDay; i++) daysHTML += `<div></div>`;
            
            for(let i=1; i<=daysInMonth; i++) {
                const date = new Date(year, month, i);
                const dateStr = formatDateKey(date);
                const isDisabled = date < today || date > maxDate;
                
                const users = state.eventData.participants.filter(p => p.selectedDates.includes(dateStr));
                const count = users.length;
                const isBest = (!isDisabled && count > 0 && count === maxCount);

                let className = `aspect-square rounded-lg flex flex-col items-center justify-start pt-1 text-sm font-bold relative min-h-[48px] border `;
                if (isDisabled) className += `bg-slate-50 border-transparent text-slate-300`;
                else if (isBest) className += `bg-yellow-50 border-yellow-400 text-slate-800 shadow-md`;
                else className += `bg-white border-slate-100 text-slate-700`;

                let dots = '';
                if (!isDisabled && count > 0) {
                    dots = `<div class="flex flex-wrap justify-center gap-[1px] px-0.5 mt-1 w-full">
                        ${users.map(u => `<div class="w-[4px] h-[4px] rounded-full" style="background-color: ${u.color}"></div>`).join('')}
                    </div>`;
                }

                daysHTML += `<div class="${className}">
                    ${isBest ? '<div class="absolute -top-2 left-1/2 transform -translate-x-1/2 text-xs">ğŸ‘‘</div>' : ''}
                    <span>${i}</span>
                    ${dots}
                </div>`;
            }

            // Legend
            const legendHTML = state.eventData.participants.map(p => `
                <div class="flex items-center space-x-1 bg-white px-2 py-1 rounded-md border border-slate-100 shadow-sm shrink-0">
                    <div class="w-2 h-2 rounded-full" style="background-color: ${p.color}"></div>
                    <span class="text-xs text-slate-600">${p.name}</span>
                </div>
            `).join('');

            const html = `
                <div class="bg-white p-4 shadow-sm border-b flex justify-between items-center sticky top-0 z-20">
                    <h2 class="font-bold text-slate-800 truncate flex-1">${state.eventData.name}</h2>
                    <div class="flex space-x-2 shrink-0">
                        <button onclick="copyLink()" class="text-indigo-600 text-xs font-bold border border-indigo-100 px-2 py-1 rounded bg-indigo-50">åˆ†äº«</button>
                        ${state.eventData.organizerId === currentUser.uid ? 
                            `<button onclick="goToAdmin()" class="text-slate-500 text-xs font-bold border border-slate-200 px-2 py-1 rounded bg-slate-50">ç®¡ç†</button>` : ''}
                    </div>
                </div>
                
                <div class="bg-slate-50 p-2 overflow-x-auto flex space-x-2 border-b border-slate-200 scrollbar-hide">
                    ${legendHTML || '<span class="text-xs text-slate-400 w-full text-center">å°šç„¡åƒèˆ‡è€…</span>'}
                </div>

                <div class="bg-white p-2 flex justify-between items-center text-sm text-slate-500 border-b border-slate-100">
                     <span>${year}å¹´ ${monthNames[month]}</span>
                     <div class="space-x-1">
                        <button onclick="changeMonth(-1)" class="px-2 bg-slate-100 rounded hover:bg-slate-200">â†</button>
                        <button onclick="changeMonth(1)" class="px-2 bg-slate-100 rounded hover:bg-slate-200">â†’</button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-2 bg-slate-50">
                    <div class="calendar-grid mb-1 text-center text-xs text-slate-400 font-bold">
                        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                    </div>
                    <div class="calendar-grid">
                        ${daysHTML}
                    </div>
                </div>

                <div class="p-4 bg-white border-t border-slate-100 shadow-lg z-20">
                    <button onclick="renderCalendar()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-4 rounded-xl shadow-md transition">
                        ${state.eventData.participants.find(p => p.name === state.userName) ? 'ä¿®æ”¹æˆ‘çš„æ™‚é–“' : 'åŠ å…¥æŠ•ç¥¨'}
                    </button>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function renderAdmin() {
            state.view = 'admin';
            const listHTML = state.eventData.participants.map(p => `
                <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-200 shadow-sm mb-2">
                    <div class="flex items-center space-x-3">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${p.color}"></span>
                        <div>
                            <div class="text-sm font-bold text-slate-800">${p.name}</div>
                            <div class="text-xs text-slate-400">å·²é¸ ${p.selectedDates.length} å¤©</div>
                        </div>
                    </div>
                    <button onclick="deleteParticipant('${p.name}')" class="text-red-500 text-xs border border-red-100 bg-red-50 px-3 py-1 rounded font-bold">ç§»é™¤</button>
                </div>
            `).join('');

            const html = `
                <div class="bg-slate-800 p-4 text-white flex justify-between items-center sticky top-0 z-20">
                    <div class="flex items-center space-x-2">
                        <button onclick="goToResult()" class="text-slate-300 hover:text-white font-bold">â† è¿”å›</button>
                        <span class="font-bold">å¾Œå°ç®¡ç†</span>
                    </div>
                </div>
                <div class="flex-1 p-4 bg-slate-50 overflow-y-auto">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">åƒèˆ‡è€…åå–®</h3>
                    ${listHTML || '<div class="text-center text-slate-400 py-4">ç›®å‰æ²’æœ‰åƒèˆ‡è€…</div>'}
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function renderNotFound() {
            document.getElementById('main-content').innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center p-8 text-center">
                    <div class="text-4xl mb-4">ğŸ˜•</div>
                    <h2 class="text-xl font-bold text-slate-800">æ‰¾ä¸åˆ°æ´»å‹•</h2>
                    <p class="text-slate-500 mt-2">é€£çµå¯èƒ½å·²å¤±æ•ˆæˆ–æ´»å‹• ID éŒ¯èª¤ã€‚</p>
                    <a href="/" class="mt-6 text-indigo-600 font-bold hover:underline">å»ºç«‹æ–°æ´»å‹•</a>
                </div>
            `;
        }

        // Start App
        initApp();

    </script>
</body>
</html>
